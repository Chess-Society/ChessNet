import{w as f}from"./B4zm7d7r.js";import{l as i}from"./DgpHRp1_.js";const g="chessnet-updates";let o=null;"BroadcastChannel"in window&&(o=new BroadcastChannel(g));function u(t){if(o){const e={...t,timestamp:Date.now()};o.postMessage(e)}}function S(t){return o&&(o.onmessage=e=>{t(e.data)}),()=>{o&&(o.onmessage=null)}}const r={centers:[],students:[],classes:[],skills:[],tournaments:[],attendance:[],payments:[],plans:[],leads:[],reports:[],unlockedAchievements:[],settings:{plan:"free"},dashboardLayout:[]},y={free:{centers:1,classes:2,students:10,tournaments:!1,reports:!1},profe:{centers:3,classes:10,students:50,tournaments:!1,reports:!0},club:{centers:1/0,classes:1/0,students:1/0,tournaments:!0,reports:!0}};function k(t,e){const s=t.settings.plan,n=y[s][e];return typeof n=="boolean"?n:t[e].length<n}const a=f(r),l="chessnet_data_v1";let c=!1;function w(){if(typeof localStorage>"u")return;const t=localStorage.getItem(l);if(t)try{const e=JSON.parse(t);a.set({...r,...e}),i.info("Data loaded successfully from localStorage","Storage",{studentCount:e.students?.length||0,centerCount:e.centers?.length||0,classCount:e.classes?.length||0})}catch(e){i.error("Failed to load data from localStorage - data corrupted","Storage",e),console.error("Error cargando datos:",e),typeof window<"u"&&confirm("Los datos guardados están corruptos. ¿Deseas resetear la aplicación?")&&(localStorage.removeItem(l),a.set(r),i.warn("User chose to reset corrupted data","Storage"))}else i.info("No saved data found, using initial state","Storage");S(e=>{if(e.type==="tournament-update"){const s=localStorage.getItem(l);if(s)try{const n=JSON.parse(s);a.set({...r,...n})}catch(n){console.error("Error syncing data from broadcast:",n)}}}),c=!0}a.subscribe(t=>{if(typeof localStorage<"u"&&c)try{const e=JSON.stringify(t);new Blob([e]).size>5*1024*1024&&console.warn("Los datos están ocupando mucho espacio. Considera exportar y limpiar datos antiguos."),localStorage.setItem(l,e)}catch(e){console.error("Error guardando datos:",e),e instanceof DOMException&&e.name==="QuotaExceededError"&&typeof window<"u"&&alert("No hay suficiente espacio en el navegador para guardar los datos. Por favor, exporta tus datos y limpia registros antiguos.")}});const A={addCenter:t=>{a.update(e=>({...e,centers:[...e.centers,t]}))},removeCenter:t=>{a.update(e=>({...e,centers:e.centers.filter(s=>s.id!==t)}))},addStudent:t=>{const e={...t,joinedAt:t.joinedAt||new Date().toISOString()};a.update(s=>({...s,students:[...s.students,e]}))},updateStudent:t=>{a.update(e=>({...e,students:e.students.map(s=>s.id===t.id?t:s)}))},removeStudent:t=>{a.update(e=>({...e,students:e.students.filter(s=>s.id!==t)}))},toggleStudentSkill:(t,e)=>{a.update(s=>({...s,students:s.students.map(n=>{if(n.id!==t)return n;const d=n.skills||[],p=d.includes(e);return{...n,skills:p?d.filter(m=>m!==e):[...d,e]}})}))},addClass:t=>{a.update(e=>({...e,classes:[...e.classes,t]}))},updateClass:t=>{a.update(e=>({...e,classes:e.classes.map(s=>s.id===t.id?t:s)}))},removeClass:t=>{a.update(e=>({...e,classes:e.classes.filter(s=>s.id!==t)}))},addClassMember:(t,e)=>{a.update(s=>({...s,classes:s.classes.map(n=>n.id===t&&!n.students.includes(e)?{...n,students:[...n.students,e]}:n)}))},removeClassMember:(t,e)=>{a.update(s=>({...s,classes:s.classes.map(n=>n.id===t?{...n,students:n.students.filter(d=>d!==e)}:n)}))},addSkill:t=>{a.update(e=>({...e,skills:[...e.skills,t]}))},updateSkill:(t,e)=>{a.update(s=>({...s,skills:s.skills.map(n=>n.id===t?{...n,...e}:n)}))},deleteSkill:t=>{a.update(e=>({...e,skills:e.skills.filter(s=>s.id!==t),students:e.students.map(s=>({...s,skills:s.skills?.filter(n=>n!==t)||[]}))}))},addTournament:t=>{a.update(e=>({...e,tournaments:[...e.tournaments,t]})),u({type:"tournament-update",tournamentId:t.id})},updateTournament:t=>{a.update(e=>({...e,tournaments:e.tournaments.map(s=>s.id===t.id?t:s)})),u({type:"tournament-update",tournamentId:t.id})},removeTournament:t=>{a.update(e=>({...e,tournaments:e.tournaments.filter(s=>s.id!==t)}))},saveAttendance:t=>{a.update(e=>{const s=e.attendance.filter(n=>!(n.classId===t.classId&&n.date===t.date));return{...e,attendance:[...s,t]}})},addPayment:t=>{a.update(e=>({...e,payments:[t,...e.payments]}))},removePayment:t=>{a.update(e=>({...e,payments:e.payments.filter(s=>s.id!==t)}))},addLessonPlan:t=>{a.update(e=>({...e,plans:[t,...e.plans]}))},removeLessonPlan:t=>{a.update(e=>({...e,plans:e.plans.filter(s=>s.id!==t)}))},addLead:t=>{a.update(e=>({...e,leads:[t,...e.leads]}))},updateLead:t=>{a.update(e=>({...e,leads:e.leads.map(s=>s.id===t.id?t:s)}))},removeLead:t=>{a.update(e=>({...e,leads:e.leads.filter(s=>s.id!==t)}))},reset:()=>{a.set(r)},updateDashboardLayout:t=>{a.update(e=>({...e,dashboardLayout:t}))},updateSettings:t=>{a.update(e=>({...e,settings:{...e.settings,...t}}))},unlockAchievement:t=>{a.update(e=>e.unlockedAchievements.some(s=>s.id===t)?e:{...e,unlockedAchievements:[...e.unlockedAchievements,{id:t,unlockedAt:new Date().toISOString()}]})}};export{a,k as c,w as i,S as o,A as s};
